CREATE DATABASE QL_BOOKSTORE
USE QL_BOOKSTORE

--ALTER TABLE THAMSO ADD ID INT IDENTITY(1,1) PRIMARY KEY
--ALTER TABLE TON ADD MASACH CHAR(10) FOREIGN KEY REFERENCES SACH(MASACH)

CREATE TABLE THAMSO(
	ID INT IDENTITY(1,1) PRIMARY KEY,
	SL_NHAPITNHAT INT,
	SL_TONTOIDATRUOCNHAP INT,
	SL_TONSAUTOITHIEU INT,
	SOTIENNOTOIDA MONEY,
	SUDUNGQUYDINH BIT
)
CREATE TABLE SACH(
	MASACH CHAR(10) PRIMARY KEY,
	TENSACH NVARCHAR(100),
	THELOAI NVARCHAR(50),
	TACGIA NVARCHAR(100),
	SL_TON INT,
	DONGIA MONEY
)

CREATE TABLE KHACHHANG(
	MAKH CHAR(10) PRIMARY KEY,
	HOTEN NVARCHAR(100),
	DIACHI NVARCHAR(100),
	DIENTHOAI NVARCHAR(20),
	EMAIL NVARCHAR(50),
	SOTIENNO MONEY
)

CREATE TABLE NHAP(
	MAPN CHAR(10) PRIMARY KEY,
	NGAYNHAP SMALLDATETIME
)

CREATE TABLE CTPN(
	MACTPN CHAR(10) PRIMARY KEY,
	MAPN CHAR(10) FOREIGN KEY REFERENCES NHAP(MAPN),
	MASACH CHAR(10) FOREIGN KEY REFERENCES SACH(MASACH), /*Chỉ nhập các đầu sách có sl_tồn<300*/
	SL_NHAP INT CHECK (SL_NHAP >= 150)
)

CREATE TABLE HOADON(
	MAHD CHAR(10) PRIMARY KEY,
	MAKH CHAR(10) FOREIGN KEY REFERENCES KHACHHANG(MAKH),
	NGAYHD SMALLDATETIME
)

CREATE TABLE CTHD(
	MACTHD CHAR(10) PRIMARY KEY,
	MASACH CHAR(10) FOREIGN KEY REFERENCES SACH(MASACH), /*Chỉ bán cho khách hàng có Nợ<=20000*/
	MAHD CHAR(10) FOREIGN KEY REFERENCES HOADON(MAHD), /*Sl_ton_sau>=20*/
	SL_BAN INT
)

CREATE TABLE THUTIEN(
	MATHU CHAR(10) PRIMARY KEY,
	MAKH CHAR(10) FOREIGN KEY REFERENCES KHACHHANG(MAKH), 
	NGAYTHU SMALLDATETIME,
	SOTIENTHU MONEY /*SoTienThu<=SoTienNo trong Khách hàng*/
)

CREATE TABLE TON(
	MATON CHAR(10) PRIMARY KEY,
	MASACH CHAR(10) FOREIGN KEY REFERENCES SACH(MASACH),
	THANG INT,
	TONDAU INT,
	TONPHATSINH INT,
	TONCUOI INT
)

CREATE TABLE CONGNO(
	MACONGNO CHAR(10) PRIMARY KEY,
	MAKH CHAR(10) FOREIGN KEY REFERENCES KHACHHANG(MAKH),
	THANG INT,
	NODAU MONEY,
	NOPHATSINH MONEY,
	NOCUOI MONEY
)


--SACH--
INSERT INTO SACH VALUES('SH0001', N'Kính Vạn Hoa', N'Truyện', N'Nguyễn Nhật Ánh', 205, 13325000)
INSERT INTO SACH VALUES('SH0002', N'Yêu nhầm chị hai được nhầm em gái', N'Tiểu Thuyết', N'Leo LeoAslan', 300, 25800000)
INSERT INTO SACH VALUES('SH0003', N'Căn nhà số 13', N'Kinh dị', N'Nguyễn Nam', 325, 4875000)
INSERT INTO SACH VALUES('SH0004', N'Harry Potter', N'Giả tưởng, huyền bí, kinh dị', N'J. K. Rowling', 150, 115650000)

--KHACHHANG--
INSERT INTO KHACHHANG VALUES('KH14001', N'Phạm Văn Nghệ', N'Tây Ninh','01656149012','ilovetayninh@gmail.com',0)
INSERT INTO KHACHHANG VALUES('KH14002', N'Nguyễn Việt Phương', N'An Giang','09520295','phuongnv@gmail.com',20000)
INSERT INTO KHACHHANG VALUES('KH14003', N'Đào Thu Vân', N'TP.HCM','0987654123','vandt@gmail.com',30000)
INSERT INTO KHACHHANG VALUES('KH14004', N'Nguyễn Thanh An', N'TP.HCM','0127568123','annt@gmail.com',10000)

--NHAP--
INSERT INTO NHAP VALUES('N1400001','09/25/2014')
INSERT INTO NHAP VALUES('N1400002','09/26/2014')
INSERT INTO NHAP VALUES('N1400003','09/27/2014')

--CTPN--
INSERT INTO CTPN VALUES('CTPN140001','N1400001','SH0001', 100)
INSERT INTO CTPN VALUES('CTPN140002','N1400001','SH0004', 150)

--HOADON--
INSERT INTO HOADON VALUES('HD140001','KH14001', '09/25/2014')
INSERT INTO HOADON VALUES('HD140002','KH14002', '09/25/2014')
INSERT INTO HOADON VALUES('HD140003','KH14003', '09/26/2014')

--CTHD--
INSERT INTO CTHD VALUES('CTHD140001','SH0001','HD140001', 10)
INSERT INTO CTHD VALUES('CTHD140002','SH0002','HD140001', 3)
INSERT INTO CTHD VALUES('CTHD140003','SH0003','HD140001', 1)
INSERT INTO CTHD VALUES('CTHD140004','SH0004','HD140001', 32)
INSERT INTO CTHD VALUES('CTHD140005','SH0001','HD140002', 1)
INSERT INTO CTHD VALUES('CTHD140006','SH0002','HD140002', 3)
INSERT INTO CTHD VALUES('CTHD140007','SH0003','HD140002', 1)
INSERT INTO CTHD VALUES('CTHD140008','SH0004','HD140002', 10)

--THUTIEN--
INSERT INTO THUTIEN VALUES('TT140001','KH14001','09/25/2014',300000)
INSERT INTO THUTIEN VALUES('TT140002','KH14002','09/25/2014',1500000)

--TON--
INSERT INTO TON VALUES('TON140001',1,5,1,2,'SH0001')
INSERT INTO TON VALUES('TON140002',1,6,3,1,'SH0002')

--CONGNO--
INSERT INTO CONGNO VALUES('CN140001','KH14001',1,320000,25000,27000)
INSERT INTO CONGNO VALUES('CN140002','KH14002',1,450000,50000,36000)